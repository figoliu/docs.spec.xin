# 功能规范: 构建文档静态网站

**功能分支**: 
`001-static-docs-site`

**创建时间**: 2025-11-07

**状态**: 草稿

**批准**: FIGO

**批准日期**: 2025-11-07

**输入**: 用户描述: "构建一个文档网站，将仓库中的 Markdown 渲染为静态网站，支持 CI 自动构建并部署到静态托管平台（平台示例与实现建议见 `implementation-notes.md`），包含版本与中文支持。"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 自动化发布（优先级: P1 — 高）

作为文档作者，

我希望将 Markdown 文档提交到仓库后，文档能自动构建并发布为静态网站，

以便用户可以通过稳定的 URL 访问最新文档而无需手动构建或维护托管流程。

**优先级原因**: 这是最核心的可交付价值——把作者的 Markdown 转换为可访问站点。

**独立测试**: 在仓库中新增或更新一篇 Markdown（例如 docs/guide.md），推送后在 CI 完成后访问站点相应页面并验证内容已更新。

**验收场景**:

1. **给定** 仓库分支包含 docs/guide.md，**当** 作者在该分支推送变更，**那么** CI 自动触发构建，构建成功后变更在主站点上可见并且页面内容包含新提交的文档片段。
2. **给定** 作者在 feature 分支提交文档并发起 PR，**当** PR 构建完成，**那么** 系统应提供 PR 预览 URL，且预览页面渲染与主站构建一致（仅数据为 feature 分支内容）。

---

### 用户故事 2 - PR 预览与审阅（优先级: P2 — 高）

作为评审者，

我希望在 PR 中直接查看文档预览链接，

**独立测试**: 创建包含文档变更的 PR（例如修改 docs/guide.md 并添加新的中文段落），等待 CI 完成，查看 CI 提交/PR 注释中的预览 URL；在预览页面中验证：

- 中文段落按原样渲染且无编码/乱码问题；
- 目录（Table of Contents）正确生成且链接到对应章节；
- 图片与相对链接在预览上下文中有效。

**验收场景**: 

1. **给定** 一个包含 docs/ 更改的 PR，**当** CI 在 PR 上运行并部署预览，**那么** PR 注释或状态应包含可访问的预览 URL，且预览页面无渲染错误（中文显示正确、链接有效）。
2. **给定** 文档包含外部链接或本地图片，**当** 在 PR 预览中打开相应页面，**那么** 外部链接应可点击且本地图片正常显示或有合理占位/错误提示（若资源受限）。

---

### 用户故事 3 - 多版本与回滚（优先级: P3 — 低）

作为维护者，

我希望能够对站点发布版本进行标记并在必要时回滚到先前版本，

以便在错误发布或需要快速恢复时能够将站点恢复到已知良好状态。

**优先级原因**: 版本管理是生产站点稳定性的关键，允许快速恢复与审计历史变更。

**独立测试**: 在仓库中创建一个带有文档变更的 tag/release 或手动触发发布流程；验证发布后站点提供对应版本的访问路径（例如 /v/1.2.3/）；触发回滚操作（部署先前 tag 或回退到上一个已知良好提交），验证主站点内容恢复至目标版本。

**验收场景**: 

1. **给定** 已有版本 v1.0.0 在站点上，**当** 发布 v1.1.0（包含若干文档改动），**那么** 站点应同时保留 v1.0.0 的历史页面（或提供版本切换），且主站点显示 v1.1.0 内容。
2. **给定** v1.1.0 发布后发现重大渲染错误，**当** 触发回滚到 v1.0.0，**那么** 主站点应迅速恢复到 v1.0.0 的内容并在运维日志中记录回滚原因与操作人。

---

[根据需要添加更多用户故事, 每个都分配优先级]

## Clarifications

### Session 2025-11-07

- Q: 用户故事优先级如何分配？ → A: 用户故事1 与 用户故事2 优先级为 高；用户故事3 优先级为 低。
- Q: 页面规模考虑范围？ → A: 页面总数上限为 200 页；不考虑超过 200 页的情形。

### 边界情况

- 构建规模与并发：本项目假定站点页面总数上限为 200 页；因此无需考虑千级页面的复杂扩展。针对 ≤200 页的站点，应采用增量构建与缓存以优化体验，并在 plan.md 中定义并发构建上限、超时与失败降级策略以处理突发负载。
- 大型静态资产：若文档引用大量高分辨率图片或大文件，应采用外部对象存储或 CDN 托管，构建过程中进行资源优化（压缩、生成缩略图），并提供替代占位符策略以防资源不可用。
- 相对链接与锚点失效：文档重命名或目录调整可能导致相对链接/锚点断裂。构建流程必须包含链接与锚点验证；对于发现的断链应提供明确警告并可配置为阻断合并。
- 私有与受限内容：如果存在仅限内部访问的文档，部署流程需支持访问控制（私有站点或受限路径），并确保 PR 预览不会意外公开受限内容（例如通过分支隔离或预览权限控制）。
- 国际化与中文优先：将中文设为主语言可能导致部分第三方渲染/搜索工具兼容问题。必须在 front-matter 明确 language 字段，并为多语言内容制定翻译与回退策略。
- CI 资源配额与成本：CI 平台存在并发与分钟配额限制（详见 `implementation-notes.md` 中的示例）。需定义缓存策略、并发限制与优先级队列，防止因超额构建导致延迟或费用激增。
- 外部依赖不可用：构建若依赖外部资源（字体、CDN、API），应提供离线构建回退或本地镜像策略，避免因外部服务中断导致构建失败。
- 搜索索引规模：全站搜索索引在大规模文档下会变大，需限制索引字段、分片或采用按需加载/服务端索引以控制前端包大小与加载时间。
- 版本保留与存储成本：保留所有历史版本会增加存储和带宽成本。必须在发布策略中明确版本保留政策（例如仅保留最近 N 个版本或按标签保留），并评估长期存储影响。
- 安全与渲染风险：文档中可能包含嵌入的 HTML 或用户生成内容，渲染器必须默认进行 XSS 过滤或转义，并在需要时提供经审核的白名单策略。


## 需求 *(必填)*

本节列出针对文档静态站点的具体、可测试的功能需求。明确说明：站点以静态方式对最终用户直接可浏览为目标，不要求用户在站点上创建账户或进行验证来浏览公开文档（私有/受限版本可通过托管平台访问控制）。

### 功能需求

- **FR-001**: 系统必须在仓库中检测到对文档（Markdown）文件的新增或更新时触发自动化构建流程（支持主分支、feature 分支 PR 及标签触发）。
- **FR-002**: 系统必须将 Markdown 渲染为静态 HTML，并按目录结构映射为网站页面（包括自动生成导航与目录页）。
- **FR-003**: 系统必须为每个 Pull Request 提供一个可访问的预览 URL，渲染该 PR 所在分支上的文档内容，预览可以公开访问（仅用于审阅）或受限于托管平台设置。
- **FR-004**: 系统必须提供发布版本标记与回滚能力，能够将站点恢复到指定历史版本。
- **FR-005**: 站点默认应可直接浏览（无需在站点内创建账户或通过站点进行用户验证以阅读公开文档）；如需访问受限内容，应通过托管层或访问控制配置实现（示例见 `implementation-notes.md`）。
- **FR-006**: 系统必须以中文为主要文档语言；所有根级 README、quickstart 与主要 spec 必须至少包含中文版本或以中文为主。
- **FR-007**: 系统必须导出站点的搜索索引并支持全文或标题搜索（对用户可见）。
- **FR-008**: 系统必须在构建失败时在 PR 或提交处报告错误详情（构建日志可访问），并尽量指示失败的文件与渲染错误位置。
- **FR-009**: 系统必须支持静态托管到至少一种可用的静态托管平台，并在 `implementation-notes.md` 中提供平台中立的部署说明与可选平台示例（例如 GitHub Pages、Netlify）。

### 验收测试映射（针对关键 FR 的逐条验收步骤）

下面为规范中若干关键功能（特别是清单中被标记为需要补充验收步骤的 FR）提供逐条、可执行的验收测试步骤。每条验收测试应能在 CI/测试环境中被自动或半自动重复执行。

- FR-001: 自动触发构建
	1. 在一个受控测试分支（test/ci-trigger）中新增或修改 `docs/test-trigger.md`，提交并推送。
	2. 观察 CI（或模拟 CI 触发器）的事件记录，确认存在由该提交触发的 SiteBuild（状态: queued -> running -> success）。
	3. 在 SiteBuild 的 `logs_url` 中确认构建日志包含针对 `docs/test-trigger.md` 的渲染步骤且无致命渲染错误。
	4. 构建完成后，访问生成的网站页面或构建产物，确认页面包含 `docs/test-trigger.md` 中的新内容。

- FR-003: PR 预览提供可访问 URL
	1. 在一个 feature 分支上修改 `docs/pr-preview.md` 并推送到远程，然后在目标分支上打开 PR。
	2. 等待 CI 在该 PR 上运行并部署预览。
	3. 从 PR 状态或 CI 注释中取得 `preview_url`，并在公开或受限的浏览上下文中访问该 URL。
	4. 验证：页面按预期渲染（中文显示正确、目录与相对链接有效、图片能正确加载或展示占位符）；记录 preview 的到期时间（expires_at）并确认预览会在到期后失效或被清理。

- FR-006: 中文为主要文档语言的验证
	1. 确认仓库根级的 `README.md`、`docs/quickstart.md` 与主要 `spec` 至少包含中文段落或以中文为主。
	2. 在 CI 中运行自动化检查：检测主要页面的 front-matter `language` 字段或检查页面主体中的中文字符占比（例如 >= 60%）以判定中文优先级。
	3. 若中文缺失或不符合阈值，CI 报告失败并在 PR 中给出改进建议（例如补充中文译文或调整 front-matter）。

- FR-011: CI 中的文档质量检查（链接、拼写、中文合规性）
	1. 在目标 PR 上运行 CI，CI 任务应包含链接检查器（link-checker）、基本拼写检查（支持中文/英文）以及中文合规性规则（例如禁止某些敏感术语或保证术语一致性）。
	2. CI 应输出检查结果并将失败项附加到 PR（或通过 status/check API 报告），并在合并门禁中阻塞合并直至修复。
	3. 验证：引入一个已知断链或拼写错误的测试文档后，CI 应检测到该错误并将状态设置为失败，PR 阻断合并。

- **FR-010**: 系统必须对构建输出进行缓存或支持增量构建以减少重复构建时间，并在 CI 中尽可能利用缓存策略。
- **FR-011**: 系统必须允许在 CI 中运行文档质量检查（如链接有效性、基本拼写检查、中文文本合规性），并将检查结果作为合并门禁的一部分（失败时阻塞合并）。

### 验收场景（其余功能性需求的简短验收场景）

- FR-002: 渲染与目录
	1. 在仓库中新增 `docs/sample.md` 并触发构建。
	2. 构建产物应包含一个对应的 HTML 页面，且网站导航/目录中包含该页面的链接，点击链接能定位到页面内正确锚点。

- FR-004: 版本标记与回滚
	1. 发布一个带 tag 的构建（例如 vX.Y.Z），确认站点上存在版本路径或版本切换控件。
	2. 触发回滚到先前 tag，验证主站点内容恢复并记录回滚事件。

- FR-005: 访问控制（受限内容）
	1. 在受限路径中放置一篇文档并触发部署（配置为受限访问）。
	2. 验证公开访问时受限内容不可直接访问，而在授权或通过托管平台控制后可访问（见 implementation-notes 中示例）。

- FR-007: 搜索索引导出
	1. 在构建后生成并导出站点搜索索引文件（例如 JSON），并在站点上提供搜索功能能基于该索引返回匹配结果。

- FR-008: 构建失败报告
	1. 在 CI 中引入一个会导致渲染失败的文档（如非法 front-matter），构建应失败并在 PR/提交处显示构建日志和失败文件位置。

- FR-009: 平台部署说明
	1. 提供部署说明并在至少一种平台上成功发布站点（可用性验证）；细节与可选平台示例在 `implementation-notes.md`。

- FR-010: 缓存/增量构建
	1. 对同一分支连续小变更进行两次构建，第二次构建应利用缓存/增量构建策略显著减少构建时间或资源使用。

### 关键实体

- **Document**: 表示仓库中的单个 Markdown 文件。关键属性: path, title, language, last_modified, author。
- **SiteBuild**: 一次构建事件。关键属性: id, branch, commit, status, started_at, finished_at, logs_url。
- **Preview**: PR 关联的预览部署。关键属性: preview_url, pr_number, build_id, expires_at。
- **Version**: 标记发布的文档版本。关键属性: tag, release_date, build_id。

## 依赖与假设

- 依赖:
	- CI/构建平台（用于执行构建与发布流程，具体示例见 `implementation-notes.md`）。
	- 静态托管或 CDN（用于最终站点托管与缓存）。
	- 仓库约定的文档目录（默认假定 `docs/` 用于用户文档）。

- 假设:
	- 站点规模预期 ≤ 200 页；构建策略与性能目标基于此假设。
	- 公开文档不需要站点级别的账户验证；受限内容将通过托管层配置访问控制。
	- 中文为仓库主语言（见 FR-006），且主要 README/quickstart/主要 spec 保持中文可用。

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 在常规负载下，提交后触发构建并在 10 分钟内完成（目标 2 分钟内完成，允许高负载时上限 10 分钟）。
- **SC-002**: PR 构建完成后应在 5 分钟内提供预览 URL（目标 2 分钟）。
- **SC-003**: 至少 95% 的 Markdown 文档能在默认渲染配置下无错误生成页面（无致命渲染错误）。
- **SC-004**: 主站点的首屏渲染时间（从 CDN）中位数 < 1s（在典型用户网络条件及 CDN 缓存命中时）。
- **SC-005**: 文档质量检查（链接有效性、基本拼写检测）在 CI 中执行并在合并门禁前通过；若失败，PR 必须阻塞合并直到修复。
- **SC-006**: README/quickstart 与主要 spec 在仓库根级均提供中文版本或中文为主，检查机制能验证中文存在（自动化检查通过）。
